/**
 * Welcome to Cloudflare Workers! This is your first worker.
 *
 * - Run "npm run dev" in your terminal to start a development server
 * - Open a browser tab at http://localhost:8787/ to see your worker in action
 * - Run "npm run deploy" to publish your worker
 *
 * Learn more at https://developers.cloudflare.com/workers/
 */

export default {
  async fetch(request, env, ctx) {
    if (request.method !== 'POST') {
      return new Response('Method not allowed', { status: 405 });
    }

    try {
      const body = await request.arrayBuffer();
      const bodyBuffer = new Uint8Array(body);
      const bodyString = new TextDecoder().decode(bodyBuffer);
      
      const xeroSignature = request.headers.get('x-xero-signature');
      const webhookKey = env.XERO_WEBHOOK_KEY;
      
      if (!webhookKey) {
        console.error('XERO_WEBHOOK_KEY not configured');
        return new Response('', { status: 401 });
      }
      
      const encoder = new TextEncoder();
      const keyData = encoder.encode(webhookKey);
      const key = await crypto.subtle.importKey(
        'raw', keyData, { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
      );
      const signature = await crypto.subtle.sign('HMAC', key, bodyBuffer);
      const computedSignature = btoa(String.fromCharCode(...new Uint8Array(signature)));
      
      console.log(`Xero signature: ${xeroSignature}`);
      console.log(`Computed signature: ${computedSignature}`);
      
      if (!xeroSignature || xeroSignature !== computedSignature) {
        console.log('Signature mismatch - returning 401');
        return new Response('', { status: 401 });
      }
      
      console.log('Signature valid');
      console.log(`Redis URL: ${env.UPSTASH_REDIS_REST_URL}`);
      console.log(`Token prefix: ${env.UPSTASH_REDIS_REST_TOKEN}`);
      
      let payload;
      try {
        payload = JSON.parse(bodyString);
      } catch (e) {
        return new Response('', { status: 200 });
      }
      
      if (payload.events && payload.events.length > 0) {
        console.log(`Processing ${payload.events.length} events`);
        
        for (const event of payload.events) {
          const eventData = JSON.stringify({
            ...event,
            receivedAt: new Date().toISOString()
          });
          
          const response = await fetch(
            `${env.UPSTASH_REDIS_REST_URL}`,
            {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${env.UPSTASH_REDIS_REST_TOKEN}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(['LPUSH', 'xero_webhook_queue', eventData])
            }
          );
          const result = await response.json();
          console.log(`LPUSH result: ${JSON.stringify(result)}`);
        }
      }
      
      return new Response('', { status: 200 });
      
    } catch (error) {
      console.error(`Error: ${error.message}`);
      return new Response('', { status: 401 });
    }
  },
};
